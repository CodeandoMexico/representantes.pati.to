#!/usr/bin/env ruby
# encoding: utf-8

require_relative './common.rb'

# Busquemos todos los actores con imagen tipo String
actores = Actor.where({imagen: {'$type' => 2}})

Log.info "#{actores.count} Imágenes por descargar"

crawler = Crawler.new ''
crawler.requests = actores.map { |a| {url: a.imagen, actor: a} }
crawler.url_parser = -> (request, base) { request[:url]}

crawler.run do |img, req|
  if img.success?
    #Log.info req[:actor].distrito
  else
    Log.error "No encontré #{req[:url]} (#{req[:actor].meta.fkey})"
    req[:actor].imagen = nil
    #req[:actor].save
  end
end